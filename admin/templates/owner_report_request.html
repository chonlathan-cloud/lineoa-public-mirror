{% extends "admin/base.html" %}{% set shop_label = (shop_display_name or shop_id) or "-" %}
{% block title %}ขอรายงาน — {{ shop_label }}{% endblock %}
{% block header %}ขอรายงาน On-Demand — {{ shop_label }}{% endblock %}
{% block content %}
<div id="shopSwitcherWrap" class="card section" style="display:none;margin-bottom:16px">
  <label style="display:block;font-weight:600;margin-bottom:4px">เลือกร้าน</label>
  <select id="shopSelect" style="min-width:240px"></select>
  <p class="muted" id="shopSwitcherHint" style="margin-top:8px;display:none"></p>
</div>
<div class="card section">
  <form id="reqForm">
    <div class="row">
      <div style="flex:1 1 200px">
        <label>ประเภทรายงาน</label>
        <select name="kind" id="kind">
          <option value="mini">Full Report (มีกราฟเส้น)</option>
          <option value="full">Mini Report (4 การ์ดตัวเลข)</option>
        </select>
      </div>
      <div style="flex:1 1 200px">
        <label>เริ่มวันที่</label>
        <input type="date" name="start_date" id="start_date" required>
      </div>
      <div style="flex:1 1 200px">
        <label>ถึงวันที่</label>
        <input type="date" name="end_date" id="end_date" required>
      </div>
    </div>
    <label style="margin-top:8px">หมายเหตุ (ถ้ามี)</label>
    <input type="text" name="note" placeholder="บันทึกเพิ่มเติม">
    <div style="margin-top:12px">
      <button class="btn btn-primary" type="submit">ขอรายงาน</button>
    </div>
    <p class="muted">* ค่าเริ่มต้นคือ 14 วันที่ผ่านมา</p>
  </form>
</div>

<div class="card">
  <h3 style="margin-top:0">คำขอล่าสุด</h3>
  <div id="list"></div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID_REPORT = {{ (liff_id_report or "")|tojson }};
let shopId = "{{ shop_id or '' }}";
const listEl = document.getElementById("list");
const formEl = document.getElementById("reqForm");
const startEl = document.getElementById("start_date");
const endEl = document.getElementById("end_date");
const shopSelectEl = document.getElementById("shopSelect");
const shopSwitcherWrap = document.getElementById("shopSwitcherWrap");
const shopSwitcherHint = document.getElementById("shopSwitcherHint");

// ตั้งค่าเริ่มต้น = 14 วันล่าสุด
(function initDates(){
  const today = new Date();
  const end = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const start = new Date(end); start.setDate(end.getDate() - 13);
  const toYMD = d => d.toISOString().slice(0,10);
  startEl.value = toYMD(start);
  endEl.value = toYMD(end);
})();

async function initLiffForReportPage(){
  if (!window.liff || !LIFF_ID_REPORT) {
    return;
  }
  try {
    await liff.init({ liffId: LIFF_ID_REPORT });
  } catch (err) {
    console.error("LIFF init failed on report page", err);
  }
}

function setFormDisabled(flag){
  try{
    const elements = Array.from(formEl.elements || []);
    for(const el of elements){
      el.disabled = !!flag;
    }
  }catch(err){
    console.warn("setFormDisabled failed", err);
  }
}

async function fetchOwnerShops(){
  const res = await fetch("/owner/shops", { credentials: "include", headers: { "Accept": "application/json" } });
  if(!res.ok){
    const text = await res.text();
    throw new Error(text || "load_shops_failed");
  }
  return res.json();
}

async function postSwitchShop(nextShopId){
  const res = await fetch("/owner/switch-shop", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ shop_id: nextShopId })
  });
  let js = {};
  try{
    js = await res.json();
  }catch(err){
    js = {};
  }
  if(!res.ok || !js.ok){
    const e = new Error(js && js.error ? js.error : "switch_failed");
    e.code = js && js.error ? js.error : "switch_failed";
    throw e;
  }
  return js;
}

async function initShopSelector(){
  if(!shopSelectEl || !shopSwitcherWrap){
    return;
  }
  try{
    const data = await fetchOwnerShops();
    const items = Array.isArray(data.items) ? data.items : [];
    if(items.length <= 1){
      if(items.length === 1){
        const only = items[0];
        if(data.current_shop_id !== only.shop_id){
          await postSwitchShop(only.shop_id);
          location.reload();
          return;
        }
        shopId = only.shop_id;
      }
      shopSwitcherWrap.style.display = "none";
      return;
    }
    shopSwitcherWrap.style.display = "";
    shopSelectEl.innerHTML = ['<option value="">— เลือกร้าน —</option>'].concat(
      items.map(item => `<option value="${item.shop_id}">${item.display_name || item.shop_id}</option>`)
    ).join("");
    if(data.current_shop_id && items.some(item => item.shop_id === data.current_shop_id)){
      shopSelectEl.value = data.current_shop_id;
      shopId = data.current_shop_id;
      if(shopSwitcherHint){ shopSwitcherHint.style.display = "none"; }
    } else if(shopSwitcherHint){
      shopSwitcherHint.textContent = "กรุณาเลือกร้านเพื่อใช้งาน";
      shopSwitcherHint.style.display = "block";
    }
    shopSelectEl.addEventListener("change", async (e) => {
      const nextShop = e.target.value;
      if(!nextShop){ return; }
      shopSelectEl.disabled = true;
      try{
        await postSwitchShop(nextShop);
        location.reload();
      }catch(err){
        shopSelectEl.disabled = false;
        alert(err.message || "เปลี่ยนร้านไม่สำเร็จ");
      }
    });
  }catch(err){
    console.error("initShopSelector failed", err);
    if(shopSwitcherWrap){
      shopSwitcherWrap.style.display = "";
    }
    if(shopSwitcherHint){
      shopSwitcherHint.textContent = "โหลดรายชื่อร้านไม่สำเร็จ";
      shopSwitcherHint.style.display = "block";
    }
  }
}

async function ensureShopId(){
  if(shopId){
    return shopId;
  }
  try{
    const res = await fetch("/owner/context", { credentials: "include", headers: { "Accept": "application/json" } });
    let js = {};
    try{
      js = await res.json();
    }catch(parseErr){
      js = {};
    }
    if(res.ok && js && js.shop_id){
      shopId = js.shop_id;
      return shopId;
    }
    if(res.status === 400 && js && js.error === "shop_not_selected"){
      const err = new Error("shop_not_selected");
      err.code = "shop_not_selected";
      throw err;
    }
    throw new Error(js && js.error ? js.error : "owner_session_missing");
  }catch(err){
    if(err && err.code !== "shop_not_selected"){
      listEl.innerHTML = "ไม่พบสิทธิ์เจ้าของร้าน กรุณาเริ่มจากลิงก์ LIFF";
    }
    throw err;
  }
}

async function refreshList(){
  const sid = await ensureShopId();
  listEl.innerHTML = "Loading...";
  const res = await fetch(`/owner/${sid}/reports/requests`);
  const js = await res.json();
  listEl.innerHTML = (js.items||[]).map(x => {
    const kindLabel = x.kind === 'mini'
      ? 'Full Report (มีกราฟเส้น)'
      : x.kind === 'full'
        ? 'Mini Report (4 การ์ดตัวเลข)'
        : (x.kind || '-');
    return `
      <div class="report-card">
        <div><b>ประเภท:</b> ${kindLabel}</div>
        <div><b>ช่วงเวลา:</b> ${x.start_date ? x.start_date.slice(0,10) : "-"} → ${x.end_date ? x.end_date.slice(0,10) : "-"}</div>
        <div><b>สถานะ:</b> ${x.status}</div>
        <div class="muted">สร้างเมื่อ: ${x.created_at || "-"}</div>
        ${x.pdf_url ? `<div><a href="${x.pdf_url}" target="_blank">ดาวน์โหลดรายงาน</a></div>` : ``}
      </div>
    `;
  }).join("");
}
formEl.addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = formEl.querySelector('button[type="submit"]');
  const originalText = btn.textContent;
  btn.disabled = true; btn.textContent = 'กำลังสร้างรายงาน...';
  try {
    const sid = await ensureShopId();
    const fd = new FormData(formEl);
    const body = {}; for (const [k,v] of fd.entries()) body[k]=v;
    // 1) Create request
    const resCreate = await fetch(`/owner/${sid}/reports/requests`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const jsCreate = await resCreate.json();
    if(!resCreate.ok || !jsCreate.ok){ throw new Error('สร้างคำขอไม่สำเร็จ'); }
    const reqId = jsCreate.request_id;
    // 2) Run report immediately
    const resRun = await fetch(`/owner/${sid}/reports/requests/${reqId}/run`, { method: 'POST' });
    const jsRun = await resRun.json();
    if(!resRun.ok || !jsRun.ok){ throw new Error(jsRun.error || 'ประมวลผลรายงานไม่สำเร็จ'); }
    // 3) Open result using LIFF if available to avoid "Load failed" in webview
    if (jsRun.pdf_url) {
      if (window.liff && typeof liff.openWindow === "function") {
        liff.openWindow({ url: jsRun.pdf_url, external: true });
      } else {
        // ถ้าไม่มี LIFF object (เปิดผ่าน browser ปกติหรือ webview ทั่วไป)
        // ให้เปิดเป็นแท็บ/หน้าต่างใหม่แทนการเปลี่ยน location เดิม
        window.open(jsRun.pdf_url, "_blank");
      }
    }
    await refreshList();
    formEl.reset();
  } catch (err){
    alert(err.message || 'เกิดข้อผิดพลาด');
  } finally {
    btn.disabled = false; btn.textContent = originalText;
  }
});

setFormDisabled(true);
initShopSelector();

(async function init(){
  try{
    // Initialize LIFF for this report page (best-effort)
    await initLiffForReportPage();

    // Ensure we have a shop context
    await ensureShopId();

    // Now enable the form and load existing history
    setFormDisabled(false);
    await refreshList();
  }catch(err){
    if(err && err.code === "shop_not_selected"){
      // No active shop in session; let the UI hint from initShopSelector() guide the user.
      return;
    }
    console.error("initialization failed", err);
    alert('ไม่พบสิทธิ์เจ้าของร้าน กรุณาเปิดผ่าน LIFF อีกครั้ง');
  }
})();
</script>
<script>
// Intercept clicks on report PDF links and open them via LIFF external browser
// to avoid LIFF showing "lineoa-...run.app Load failed" overlay.
document.addEventListener("click", (ev) => {
  const target = ev.target;
  if (!target || typeof target.closest !== "function") {
    return;
  }
  const linkEl = target.closest("a");
  if (!linkEl) {
    return;
  }
  const href = linkEl.getAttribute("href") || "";
  if (!href) {
    return;
  }
  // ถ้าเป็นลิงก์ไปยังไฟล์รายงานบน GCS ให้เปิดผ่าน LIFF external แทน
  if (href.startsWith("http") && href.includes("storage.googleapis.com")) {
    ev.preventDefault();
    if (window.liff && typeof liff.openWindow === "function") {
      liff.openWindow({ url: href, external: true });
    } else {
      window.open(href, "_blank");
    }
  }
});
</script>
<style>
  /* Prevent nested/overlapping cards */
  #list .report-card {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 12px;
    background: #fff;
  }
</style>
{% endblock %}
