<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Owner Sign-in ‚Ä¢ LINE OA</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const UI_MODE = "global";
    const AUTO_START = true;
  </script>
  <style>
    :root{
      --brand:#008080;
      --accent:#F97316;
      --bg:#F5F7FB;
      --ink:#111827;
    }
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      font:15px/1.6 -apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 16px;
    }
    .page{
      width:100%;
      max-width:640px;
      background:#fff;
      border-radius:20px;
      box-shadow:0 25px 60px rgba(15,23,42,0.12);
      padding:32px 28px;
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .hero{text-align:center}
    .logo-circle{width:200px;height:180px;display:flex;align-items:center;justify-content:center;margin:0 auto}
    .logo-img{width:200px;height:auto;display:block}
    h1{margin:0;font-size:26px}
    .tagline{margin:12px auto 0;color:#6b7280;line-height:1.6}
    .highlight{
      background:#F0FDF4;
      border:1px solid #BBF7D0;
      border-radius:16px;
      padding:18px;
      color:#14532D;
    }
    .highlight ul{margin:12px 0 0 18px;padding:0}
    .highlight li{margin-bottom:6px}
    .status-card{
      background:#F9FAFB;
      border-radius:14px;
      padding:16px;
      font-size:14px;
      border:1px solid #E5E7EB;
    }
    #err{color:#b91c1c;white-space:pre-wrap;margin:12px 0 0;font-family:inherit}
    .cta{text-align:center}
    .btn{
      border:none;
      border-radius:999px;
      padding:14px 28px;
      font-size:15px;
      font-weight:600;
      background:var(--accent);
      color:#111;
      cursor:pointer;
      transition:transform .15s, box-shadow .15s;
    }
    .btn:disabled{opacity:.5;cursor:default;box-shadow:none !important}
    .btn.active:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(249,115,22,.35)}
    @media(max-width:520px){.page{padding:28px 20px}}
  </style>
</head>
<body>
  <div class="page">
    <div class="hero">
      <div class="logo-circle">
        <img src="/static/logo.png" alt="MIA logo" class="logo-img">
      </div>
      <h1>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà MIA üéâ</h1>
      <p class="tagline">
        ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br/>
        ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      </p>
    </div>

    <section class="highlight">
      <p>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ MIA ‡πÄ‡∏û‡∏∑‡πà‡∏≠</p>
      <ul>
        <li>‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å LINE OA ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô</li>
        <li>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</li>
        <li>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏≠‡∏ö‡πÅ‡∏ä‡∏ó‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</li>
      </ul>
    </section>

    <div class="status-card">
      <p id="status-text">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p>
      <pre id="err"></pre>
    </div>

    <footer class="cta">
      <button id="btn-open-shop" class="btn">MIA ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö</button>
    </footer>
  </div>
  <script>
    const LIFF_IDS = {{ (liff_ids|default([]))|tojson }};
    document.addEventListener("DOMContentLoaded", () => {
      const statusEl = document.getElementById("status-text");
      const errorEl = document.getElementById("err");
      const openBtn = document.getElementById("btn-open-shop");
      const setStatus = (text) => { if(statusEl){ statusEl.textContent = text; } };
      const showError = (msg) => {
        if(errorEl){
          errorEl.textContent = msg;
        } else {
          alert(msg);
        }
      };
      let isProcessing = false;

      const startOwnerLogin = async () => {
        if(isProcessing){
          return;
        }
        isProcessing = true;
        if(openBtn){
          openBtn.disabled = true;
          openBtn.classList.remove("active");
        }
        try{
          if(!Array.isArray(LIFF_IDS) || LIFF_IDS.length === 0){
            throw new Error("missing_liff_id");
          }
          setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‚Ä¶");
          let activeLiffId = null;
          let lastError = null;
          for(const candidate of LIFF_IDS){
            if(!candidate){ continue; }
            try{
              await liff.init({ liffId: candidate, withLoginOnExternalBrowser: true });
              activeLiffId = candidate;
              lastError = null;
              break;
            }catch(err){
              console.error("LIFF init failed", candidate, err);
              lastError = err;
            }
          }
          if(!activeLiffId){
            throw lastError || new Error("liff_init_failed");
          }
          window.__activeLiffId = activeLiffId;
          console.log("LIFF init succeeded with", activeLiffId);
          if(!liff.isLoggedIn()){
            liff.login();
            return;
          }
          const idToken = liff.getIDToken();
          if(!idToken){ throw new Error("no id_token from LIFF"); }
          const params = new URLSearchParams(location.search);
          const seenSources = new Set();
          const queue = [];
          const enqueue = (val) => {
            if(typeof val === "string" && val && !seenSources.has(val)){
              seenSources.add(val);
              queue.push(val);
            }
          };
          const toSearchParams = (raw) => {
            if(!raw){ return null; }
            let text = raw;
            try{
              text = decodeURIComponent(text);
            }catch(_err){}
            if(text.startsWith("?")){
              text = text.slice(1);
            }
            if(text.startsWith("http://") || text.startsWith("https://") || text.startsWith("/")){
              try{
                const urlObj = new URL(text, location.origin);
                const qs = urlObj.search || "";
                if(!qs){ return null; }
                return new URLSearchParams(qs.slice(1));
              }catch(_err){}
            }
            if(!text.includes("=")){
              return null;
            }
            try{
              return new URLSearchParams(text);
            }catch(_err){
              return null;
            }
          };
          const coalesceFirst = (values) => {
            if(!values){ return undefined; }
            for(const v of values){
              if(typeof v === "string" && v){
                return v;
              }
            }
            return undefined;
          };

          const nextValues = params.getAll("next");
          const sidValues = params.getAll("sid");
          const tokenValues = params.getAll("token");
          const liffStateValues = params.getAll("liff.state");

          let nextParam = coalesceFirst(nextValues);
          let sidParam = coalesceFirst(sidValues);
          let inviteToken = coalesceFirst(tokenValues);
          for(const val of nextValues){ enqueue(val); }
          for(const val of liffStateValues){ enqueue(val); }

          while(queue.length){
            const raw = queue.shift();
            const parsed = toSearchParams(raw);
            if(!parsed){ continue; }
            const nestedNext = parsed.get("next");
            if(nestedNext){
              if(!nextParam){ nextParam = nestedNext; }
              enqueue(nestedNext);
            }
            const nestedState = parsed.get("liff.state");
            if(nestedState){
              enqueue(nestedState);
            }
            if(!sidParam){
              const val = parsed.get("sid");
              if(val){ sidParam = val; }
            }
            if(!inviteToken){
              const val = parsed.get("token");
              if(val){ inviteToken = val; }
            }
          }

          const query = new URLSearchParams();
          if(nextParam){ query.set("next", nextParam); }
          if(sidParam){ query.set("sid", sidParam); }
          if(inviteToken){ query.set("token", inviteToken); }
          const endpoint = query.toString() ? `/owner/auth/liff/callback?${query.toString()}` : "/owner/auth/liff/callback";
          
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              id_token: idToken,
              sid: sidParam || undefined,
              invite_token: inviteToken || undefined
            })
          });

          if(!res.ok){
            const text = await res.text();
            // ‡∏Å‡∏£‡∏ì‡∏µ token ‡∏à‡∏≤‡∏Å LINE ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Üí ‡πÉ‡∏´‡πâ logout + login ‡πÉ‡∏´‡∏°‡πà
            if(text && text.includes("invalid_id_token") && window.liff){
              try { liff.logout(); } catch(_e){}
              setStatus("‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE ‡πÉ‡∏´‡∏°‡πà‚Ä¶");
              isProcessing = false;
              liff.login();
              return;
            }
            throw new Error(text || "auth_failed");
          }

          const js = await res.json();
          const fallback = nextParam || "/owner/promotions/form";
          const targetUrl = (js && js.redirect) || fallback;
          setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô...");
          if(window.liff && typeof liff.openWindow === "function"){
            liff.openWindow({ url: targetUrl, external: false });
          } else {
            window.location.assign(targetUrl);
          }
        } catch (e) {
          isProcessing = false;
          setStatus("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
          showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (e && e.message ? e.message : e));
          if(openBtn){
            openBtn.disabled = false;
            openBtn.classList.add("active");
          }
        }
      };

      if(openBtn){
        if(!AUTO_START){
          openBtn.disabled = false;
          openBtn.classList.add("active");
        }
        openBtn.addEventListener("click", startOwnerLogin);
      }

      if(AUTO_START){
        startOwnerLogin();
      }
    });
  </script>
</body>
</html>
