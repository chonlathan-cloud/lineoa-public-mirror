<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Owner Sign-in • LINE OA</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const UI_MODE = "addon";
    const AUTO_START = true;
  </script>
  <style>
    :root{
      --bg:#F5F7FB;
      --ink:#111827;
      --accent:#F97316;
    }
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      font:15px/1.6 -apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 16px;
    }
    .page{
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:20px;
      box-shadow:0 18px 40px rgba(15,23,42,0.15);
      padding:32px 28px;
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .muted{color:#6b7280}
    .status-card{
      background:#F9FAFB;
      border-radius:14px;
      padding:16px;
      font-size:14px;
      border:1px solid #E5E7EB;
      text-align:left;
    }
    #err{color:#b91c1c;white-space:pre-wrap;margin:12px 0 0;font-family:inherit}
    .spinner{
      width:48px;
      height:48px;
      border-radius:50%;
      border:4px solid rgba(249,115,22,0.2);
      border-top-color:var(--accent);
      margin:0 auto 12px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .btn{
      border:none;
      border-radius:999px;
      padding:14px 28px;
      font-size:15px;
      font-weight:600;
      background:var(--accent);
      color:#111;
      cursor:pointer;
      transition:transform .15s, box-shadow .15s;
    }
    .btn:disabled{opacity:.5;cursor:default;box-shadow:none}
    .btn.active:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(249,115,22,.35)}
  </style>
</head>
<body>
  <div class="page">
    <div>
      <div class="spinner"></div>
      <h1>กำลังเข้าสู่ระบบ…</h1>
      <p class="muted">โปรดรอสักครู่ ระบบกำลังตรวจสอบสิทธิ์</p>
    </div>
    <div class="status-card">
      <p id="status-text">กำลังตรวจสอบสิทธิ์เจ้าของร้าน โปรดรอสักครู่…</p>
      <pre id="err"></pre>
    </div>
    <button id="btn-open-shop" class="btn" disabled>ยินดีต้อนรับนะครับ</button>
  </div>
  <script>
    const LIFF_IDS = {{ (liff_ids|default([]))|tojson }};
    document.addEventListener("DOMContentLoaded", () => {
      const statusEl = document.getElementById("status-text");
      const errorEl = document.getElementById("err");
      const openBtn = document.getElementById("btn-open-shop");
      const setStatus = (text) => { if(statusEl){ statusEl.textContent = text; } };
      const showError = (msg) => {
        if(errorEl){
          errorEl.textContent = msg;
        } else {
          alert(msg);
        }
      };
      let isProcessing = false;

      const startOwnerLogin = async () => {
        if(isProcessing){
          return;
        }
        isProcessing = true;
        if(openBtn){
          openBtn.disabled = true;
          openBtn.classList.remove("active");
        }
        try{
          if(!Array.isArray(LIFF_IDS) || LIFF_IDS.length === 0){
            throw new Error("missing_liff_id");
          }
          setStatus("กำลังตรวจสอบสิทธิ์เจ้าของร้าน โปรดรอสักครู่…");
          let activeLiffId = null;
          let lastError = null;
          for(const candidate of LIFF_IDS){
            if(!candidate){ continue; }
            try{
              await liff.init({ liffId: candidate, withLoginOnExternalBrowser: true });
              activeLiffId = candidate;
              lastError = null;
              break;
            }catch(err){
              console.error("LIFF init failed", candidate, err);
              lastError = err;
            }
          }
          if(!activeLiffId){
            throw lastError || new Error("liff_init_failed");
          }
          window.__activeLiffId = activeLiffId;
          console.log("LIFF init succeeded with", activeLiffId);
          if(!liff.isLoggedIn()){
            liff.login();
            return;
          }
          const idToken = liff.getIDToken();
          if(!idToken){ throw new Error("no id_token from LIFF"); }
          const params = new URLSearchParams(location.search);
          const seenSources = new Set();
          const queue = [];
          const enqueue = (val) => {
            if(typeof val === "string" && val && !seenSources.has(val)){
              seenSources.add(val);
              queue.push(val);
            }
          };
          const toSearchParams = (raw) => {
            if(!raw){ return null; }
            let text = raw;
            try{
              text = decodeURIComponent(text);
            }catch(_err){}
            if(text.startsWith("?")){
              text = text.slice(1);
            }
            if(text.startsWith("http://") || text.startsWith("https://") || text.startsWith("/")){
              try{
                const urlObj = new URL(text, location.origin);
                const qs = urlObj.search || "";
                if(!qs){ return null; }
                return new URLSearchParams(qs.slice(1));
              }catch(_err){}
            }
            if(!text.includes("=")){
              return null;
            }
            try{
              return new URLSearchParams(text);
            }catch(_err){
              return null;
            }
          };
          const coalesceFirst = (values) => {
            if(!values){ return undefined; }
            for(const v of values){
              if(typeof v === "string" && v){
                return v;
              }
            }
            return undefined;
          };

          const nextValues = params.getAll("next");
          const sidValues = params.getAll("sid");
          const tokenValues = params.getAll("token");
          const liffStateValues = params.getAll("liff.state");

          let nextParam = coalesceFirst(nextValues);
          let sidParam = coalesceFirst(sidValues);
          let inviteToken = coalesceFirst(tokenValues);
          for(const val of nextValues){ enqueue(val); }
          for(const val of liffStateValues){ enqueue(val); }

          while(queue.length){
            const raw = queue.shift();
            const parsed = toSearchParams(raw);
            if(!parsed){ continue; }
            const nestedNext = parsed.get("next");
            if(nestedNext){
              if(!nextParam){ nextParam = nestedNext; }
              enqueue(nestedNext);
            }
            const nestedState = parsed.get("liff.state");
            if(nestedState){
              enqueue(nestedState);
            }
            if(!sidParam){
              const val = parsed.get("sid");
              if(val){ sidParam = val; }
            }
            if(!inviteToken){
              const val = parsed.get("token");
              if(val){ inviteToken = val; }
            }
          }

          const query = new URLSearchParams();
          if(nextParam){ query.set("next", nextParam); }
          if(sidParam){ query.set("sid", sidParam); }
          if(inviteToken){ query.set("token", inviteToken); }
          const endpoint = query.toString() ? `/owner/auth/liff/callback?${query.toString()}` : "/owner/auth/liff/callback";
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              id_token: idToken,
              sid: sidParam || undefined,
              invite_token: inviteToken || undefined
            })
          });
          if(!res.ok){
            const text = await res.text();
            throw new Error(text || "auth_failed");
          }
          const js = await res.json();
          const fallback = nextParam || "/owner/promotions/form";
          const targetUrl = (js && js.redirect) || fallback;
          setStatus("กำลังนำคุณไปยังหน้าร้าน...");
          if(window.liff && typeof liff.openWindow === "function"){
            liff.openWindow({ url: targetUrl, external: false });
          } else {
            window.location.assign(targetUrl);
          }
        } catch (e) {
          isProcessing = false;
          setStatus("เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง");
          showError("เกิดข้อผิดพลาด: " + (e && e.message ? e.message : e));
          if(openBtn){
            openBtn.disabled = false;
            openBtn.classList.add("active");
          }
        }
      };

      if(openBtn){
        if(!AUTO_START){
          openBtn.disabled = false;
          openBtn.classList.add("active");
        }
        openBtn.addEventListener("click", startOwnerLogin);
      }

      if(AUTO_START){
        startOwnerLogin();
      }
    });
  </script>
</body>
</html>
