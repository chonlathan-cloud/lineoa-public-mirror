<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô LINE OA ‡πÉ‡∏´‡∏°‡πà</title>
  <style>
    :root {
      --bg:#f5f7fb;
      --card:#ffffff;
      --border:#d7dce3;
      --ink:#1f2937;
      --accent:#2563eb;
      --accent-soft:rgba(37,99,235,0.08);
      --danger:#ef4444;
      --muted:#6b7280;
    }
    body {
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
    }
    .wrap {
      max-width:720px;
      margin:0 auto;
      padding:24px 16px 64px;
    }
    h1 {
      font-size:24px;
      margin:0 0 16px;
    }
    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:20px;
      margin-bottom:20px;
      box-shadow:0 12px 35px -20px rgba(15,23,42,0.5);
    }
    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px;
    }
    label {
      display:block;
      font-weight:600;
      margin-bottom:6px;
    }
    input[type=text],
    textarea {
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      font:inherit;
      background:#fff;
      box-sizing:border-box;
    }
    textarea {
      min-height:100px;
      resize:vertical;
    }
    input[readonly] {
      background:#f3f4f6;
      color:var(--muted);
    }
    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 18px;
      border:none;
      border-radius:12px;
      background:var(--accent);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:transform 0.15s ease,box-shadow 0.15s ease;
    }
    .btn:hover { transform:translateY(-1px); box-shadow:0 12px 22px -16px rgba(37,99,235,0.9); }
    .muted { color:var(--muted); font-size:13px; margin-top:4px; }
    .section-title { font-size:16px; font-weight:700; margin:4px 0 12px; }
    .alert {
      background:rgba(239,68,68,0.08);
      border:1px solid rgba(239,68,68,0.4);
      color:var(--danger);
      padding:12px 16px;
      border-radius:12px;
      margin-bottom:16px;
    }
    .summary {
      background:var(--accent-soft);
      border-radius:12px;
      padding:14px;
      margin-top:12px;
      overflow:auto;
      font-size:13px;
    }
    .prefill-card{
      margin-top:16px;
      padding:14px;
      border-radius:12px;
      background:#f9fafc;
      border:1px dashed var(--border);
      display:flex;
      gap:14px;
      align-items:center;
    }
    .prefill-card img{
      width:64px;
      height:64px;
      object-fit:cover;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
    }
    .prefill-meta{
      flex:1;
    }
    .prefill-meta div{
      font-size:14px;
      margin-bottom:4px;
    }
    @media (max-width:540px) {
      .card { padding:16px; }
      h1 { font-size:21px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    {% set prefill_payment = (prefill_data.payment if prefill_data else {}) or {} %}
    <h1>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô LINE OA ‡πÉ‡∏´‡∏°‡πà (Admin)</h1>

    {% if errors %}
      <div class="alert">
        <strong>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ:</strong>
        <ul style="margin:8px 0 0 18px;padding:0;">
          {% for err in errors %}
            <li>{{ err }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post" class="card" enctype="multipart/form-data">
      <input type="hidden" name="prefill_id" value="{{ prefill_id }}">
      <div class="section-title">‡∏Ñ‡πà‡∏≤ Global (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</div>
      <div class="grid">
        <div>
          <label>GLOBAL_LIFF_ID</label>
          <input type="text" readonly value="{{ env_info.GLOBAL_LIFF_ID }}">
        </div>
        <div>
          <label>LIFF_ID_REPORT</label>
          <input type="text" readonly value="{{ env_info.LIFF_ID_REPORT }}">
        </div>
        <div>
          <label>LIFF_ID_PROMOTION</label>
          <input type="text" readonly value="{{ env_info.LIFF_ID_PROMOTION }}">
        </div>
        <div>
          <label>GLOBAL_LINE_LOGIN_CHANNEL_ID</label>
          <input type="text" readonly value="{{ env_info.GLOBAL_LINE_LOGIN_CHANNEL_ID }}">
        </div>
        <div>
          <label>MEDIA_BUCKET</label>
          <input type="text" readonly value="{{ env_info.MEDIA_BUCKET }}">
        </div>
        <div>
          <label>REPORT_BUCKET</label>
          <input type="text" readonly value="{{ env_info.REPORT_BUCKET }}">
        </div>
      </div>

      <hr style="margin:20px -20px; border:none; border-top:1px solid var(--border);">

      {% if prefill_data %}
        <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠ onboarding</div>
        <div class="prefill-card">
          {% if prefill_data.logo_url %}
            <img src="{{ prefill_data.logo_url }}" alt="logo">
          {% else %}
            <img src="https://dummyimage.com/128x128/d1d5db/1f2937&text=LOGO" alt="logo">
          {% endif %}
          <div class="prefill-meta">
            <div><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:</strong> {{ prefill_data.shop or "-" }}</div>
            <div><strong>‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> {{ prefill_data.name or "-" }}</div>
            <div><strong>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> {{ prefill_data.phone or "-" }}</div>
            {% if prefill_data.location and prefill_data.location.address %}
              <div><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> {{ prefill_data.location.address }}</div>
            {% endif %}
            {% if prefill_data.messaging_user_id %}
              <div><strong>LINE user ID:</strong> {{ prefill_data.messaging_user_id }}</div>
            {% endif %}
            {% if prefill_payment.payment_promptpay or prefill_payment.payment_note or prefill_payment.payment_qr_url %}
              <div style="margin-top:6px">
                <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô:</strong>
                <div class="muted" style="margin-top:4px">
                  {% if prefill_payment.payment_promptpay %}<div>PromptPay/‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: {{ prefill_payment.payment_promptpay }}</div>{% endif %}
                  {% if prefill_payment.payment_note %}<div>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: {{ prefill_payment.payment_note }}</div>{% endif %}
                  {% if prefill_payment.payment_qr_url %}<div>QR code: <a href="{{ prefill_payment.payment_qr_url }}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</a></div>{% endif %}
                </div>
              </div>
            {% endif %}
          </div>
          <div>
            <a class="muted" href="/admin/oa/requests" style="text-decoration:none;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠</a>
          </div>
        </div>
      {% endif %}

      <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OA ‡πÉ‡∏´‡∏°‡πà</div>
      <div class="grid">
        <div>
          <label>Channel ID *</label>
          <input type="text" name="channel_id" value="{{ form.channel_id }}" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2008xxxxxx" required>
        </div>
        <div>
          <label>LINE OA Display Name</label>
          <input type="text" name="oa_display_name" value="{{ form.oa_display_name }}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô LINE OA">
        </div>
        <div>
          <label>LINE OA ID (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <input type="text" name="line_oa_id" value="{{ form.line_oa_id }}" placeholder="Uxxxxxxxxxxxxxxxxxxxxx">
        </div>
      </div>

      <label style="margin-top:16px;">Channel Access Token *</label>
      <textarea name="line_channel_access_token" placeholder="‡∏ô‡∏≥‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (one-time)" required></textarea>
      <p class="muted">* ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• via Secret Manager (‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</p>

      <label style="margin-top:16px;">Channel Secret *</label>
      <textarea name="line_channel_secret" placeholder="Channel secret (one-time)" required></textarea>

      <hr style="margin:20px -20px; border:none; border-top:1px solid var(--border);">
      <div class="section-title">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
      <p class="muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏¥‡∏ò‡∏µ ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç PromptPay/‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ QR code ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ</p>
      <label>PromptPay / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
      <input type="text" name="payment_promptpay" value="{{ form.payment_promptpay }}" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678 ‡∏´‡∏£‡∏∑‡∏≠ 123-4-56789-0">
      <label style="margin-top:12px;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î QR code (PNG/JPG)</label>
      <input type="file" name="payment_qr_file" accept="image/png,image/jpeg">
      {% if prefill_payment.payment_qr_url %}
        <p class="muted">‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: <a href="{{ prefill_payment.payment_qr_url }}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π QR ‡πÄ‡∏î‡∏¥‡∏°</a></p>
      {% endif %}
      <label style="margin-top:12px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£)</label>
      <textarea name="payment_note" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô" rows="3">{{ form.payment_note }}</textarea>

      <div style="margin-top:20px;">
        <button type="submit" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å OA ‡πÉ‡∏´‡∏°‡πà</button>
      </div>
    </form>

    {% if result %}
      <div class="card">
        <div class="section-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ</div>
        {% if result.invite_info %}
          <p class="muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
        {% endif %}
        <div class="grid">
          <div>
            <label>Shop ID</label>
            <input type="text" readonly value="{{ result.shop_id }}">
          </div>
          {% if result.prefill_id %}
          <div>
            <label>Request ID</label>
            <input type="text" readonly value="{{ result.prefill_id }}">
          </div>
          {% endif %}
          <div>
            <label>Owner Sign-in URL</label>
            <input type="text" readonly value="{{ result.owner_signin_url }}">
            <p class="muted">‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡∏ú‡πà‡∏≤‡∏ô Global LIFF)</p>
          </div>
          <div>
            <label>Webhook URL (Consumer)</label>
            <input type="text" readonly value="{{ result.webhook_url }}">
          </div>
        </div>

        {% if result.invite_info %}
          <div class="section-title" style="margin-top:18px;">Owner Invite Link</div>
          <div class="summary">
            <div><strong>‡∏•‡∏¥‡∏á‡∏Å‡πå:</strong> <a href="{{ result.invite_info.url }}" target="_blank">{{ result.invite_info.url }}</a></div>
            {% if result.invite_info.token %}
              <div><strong>Token:</strong> {{ result.invite_info.token }}</div>
            {% endif %}
            <div><strong>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏ä‡∏¥‡∏ç (jti):</strong> {{ result.invite_info.jti }}</div>
            {% if result.invite_info.messaging_user_id %}
              <div><strong>‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á LINE user:</strong> {{ result.invite_info.messaging_user_id }}</div>
            {% endif %}
            <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó:</strong>
              {% if result.invite_info.error %}
                <span style="color:#b91c1c;">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ({{ result.invite_info.error }})</span>
              {% else %}
                {% if result.invite_info.pushed %}
                  <span style="color:#0f766e;">‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
                {% elif result.invite_info.push_error %}
                  <span style="color:#b91c1c;">‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ({{ result.invite_info.push_error }})</span>
                {% else %}
                  <span class="muted">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                {% endif %}
              {% endif %}
            </div>
            <p class="muted">‡∏™‡∏≥‡∏£‡∏≠‡∏á: ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
          </div>
        {% endif %}

        <div class="section-title" style="margin-top:18px;">Credentials</div>
        <div class="grid">
          <div>
            <label>Channel Access Token</label>
            <input type="text" readonly value="{{ result.secrets.access_token }}">
          </div>
          <div>
            <label>Channel Secret</label>
            <input type="text" readonly value="{{ result.secrets.channel_secret }}">
          </div>
        </div>

        <div class="section-title" style="margin-top:18px;">Saved Settings Payload</div>
        <pre class="summary">{{ result.settings | tojson(indent=2) }}</pre>
        <p class="muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà <a href="/admin/oa/owners?shop_id={{ result.shop_id }}">/admin/oa/owners?shop_id={{ result.shop_id }}</a></p>
        <div style="margin-top:18px;">
          <button type="button" class="btn" onclick="saveAdminOaNewResult()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô (JSON)</button>
          <p class="muted">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ settings ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå .json ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</p>
        </div>
      </div>
    {% endif %}
  </div>
  {% if result %}
  <script>
    window.__adminOaNewResult = {{ result | tojson }};
    function verifyAndStoreOwnerSigninUrl(payload){
      if(!payload){ return null; }
      const raw = payload.owner_signin_url;
      if(!raw){ return null; }
      try{
        const urlObj = new URL(raw, window.location.origin);
        const normalized = urlObj.href;
        payload.owner_signin_url = normalized;
        try{
          const key = `owner_signin_url:${payload.shop_id || "unknown"}`;
          const entry = {
            shop_id: payload.shop_id || null,
            owner_signin_url: normalized,
            saved_at: new Date().toISOString(),
          };
          localStorage.setItem(key, JSON.stringify(entry));
        }catch(storageErr){
          console.warn("store owner_signin_url failed", storageErr);
        }
        return normalized;
      }catch(err){
        console.error("owner_signin_url invalid", err);
        return null;
      }
    }

    function saveAdminOaNewResult(){
      const payload = window.__adminOaNewResult;
      if(!payload){
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        return;
      }
      const verifiedUrl = verifyAndStoreOwnerSigninUrl(payload);
      if(!verifiedUrl){
        const confirmSave = confirm("‡∏•‡∏¥‡∏á‡∏Å‡πå Owner Sign-in ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
        if(!confirmSave){
          return;
        }
      }
      try{
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const filename = `shop_${payload.shop_id || "oa_new"}.json`;
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        requestAnimationFrame(() => {
          URL.revokeObjectURL(link.href);
          link.remove();
        });
      }catch(err){
        console.error("saveAdminOaNewResult failed", err);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ");
      }
    }
    window.addEventListener("load", () => {
      if(window.__adminOaNewResult){
        verifyAndStoreOwnerSigninUrl(window.__adminOaNewResult);
        console.info("admin OA new ready", window.__adminOaNewResult.shop_id);
      }
    });
  </script>
  {% endif %}
</body>
</html>
